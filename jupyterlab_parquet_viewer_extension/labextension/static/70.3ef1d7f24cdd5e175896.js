"use strict";(self.webpackChunkjupyterlab_parquet_viewer_extension=self.webpackChunkjupyterlab_parquet_viewer_extension||[]).push([[70],{70:(e,t,s)=>{s.r(t),s.d(t,{default:()=>p});var i=s(561),a=s(560),n=s(256),r=s(297),o=s(860);async function l(e="",t={}){const s=o.ServerConnection.makeSettings(),i=r.URLExt.join(s.baseUrl,"jupyterlab-parquet-viewer-extension",e);let a;try{a=await o.ServerConnection.makeRequest(i,t,s)}catch(e){throw new o.ServerConnection.NetworkError(e)}let n=await a.text();if(n.length>0)try{n=JSON.parse(n)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new o.ServerConnection.ResponseError(a,n.message||n);return n}class c extends n.Widget{constructor(e,t){super(),this._columns=[],this._data=[],this._totalRows=0,this._unfilteredTotalRows=0,this._currentOffset=0,this._limit=500,this._loading=!1,this._hasMore=!0,this._filters={},this._sortBy=null,this._sortOrder="asc",this._fileSize=0,this._caseInsensitive=!1,this._useRegex=!1,this._contextMenuOpen=!1,this._columnWidths=new Map,this._resizing=null,this._cleanupHighlight=null,this._menuObserver=null,this._doResize=e=>{if(!this._resizing)return;const t=e.clientX-this._resizing.startX,s=Math.max(80,this._resizing.startWidth+t);this._columnWidths.set(this._resizing.columnName,s);const i=this._columns.findIndex(e=>e.name===this._resizing.columnName);if(-1!==i){const e=this._headerRow.children[i],t=this._filterRow.children[i];e&&(e.style.width=`${s}px`),t&&(t.style.width=`${s}px`),this._tbody.querySelectorAll("tr").forEach(e=>{const t=e.children[i];t&&(t.style.width=`${s}px`)})}},this._stopResize=()=>{this._resizing&&(this._resizing=null,document.removeEventListener("mousemove",this._doResize),document.removeEventListener("mouseup",this._stopResize),document.body.style.userSelect="",document.body.style.cursor="")},this._filePath=e,this._setLastContextMenuRow=t,this.addClass("jp-ParquetViewer"),this._tableContainer=document.createElement("div"),this._tableContainer.className="jp-ParquetViewer-container",this._table=document.createElement("table"),this._table.className="jp-ParquetViewer-table",this._thead=document.createElement("thead"),this._thead.className="jp-ParquetViewer-thead",this._tbody=document.createElement("tbody"),this._tbody.className="jp-ParquetViewer-tbody",this._filterRow=document.createElement("tr"),this._filterRow.className="jp-ParquetViewer-filterRow",this._headerRow=document.createElement("tr"),this._headerRow.className="jp-ParquetViewer-headerRow",this._thead.appendChild(this._filterRow),this._thead.appendChild(this._headerRow),this._table.appendChild(this._thead),this._table.appendChild(this._tbody),this._tableContainer.appendChild(this._table),this._statusBar=document.createElement("div"),this._statusBar.className="jp-ParquetViewer-statusBar",this._statusLeft=document.createElement("div"),this._statusLeft.className="jp-ParquetViewer-statusLeft";const s=document.createElement("div");s.className="jp-ParquetViewer-statusMiddle";const i=document.createElement("label");i.className="jp-ParquetViewer-caseInsensitiveLabel",this._caseInsensitiveCheckbox=document.createElement("input"),this._caseInsensitiveCheckbox.type="checkbox",this._caseInsensitiveCheckbox.className="jp-ParquetViewer-caseInsensitiveCheckbox",this._caseInsensitiveCheckbox.checked=this._caseInsensitive,this._caseInsensitiveCheckbox.addEventListener("change",()=>{this._caseInsensitive=this._caseInsensitiveCheckbox.checked,this._loadData(!0)});const a=document.createElement("span");a.textContent=" Case insensitive",i.appendChild(this._caseInsensitiveCheckbox),i.appendChild(a),s.appendChild(i);const n=document.createElement("label");n.className="jp-ParquetViewer-regexLabel",this._regexCheckbox=document.createElement("input"),this._regexCheckbox.type="checkbox",this._regexCheckbox.className="jp-ParquetViewer-regexCheckbox",this._regexCheckbox.checked=this._useRegex,this._regexCheckbox.addEventListener("change",()=>{this._useRegex=this._regexCheckbox.checked,this._loadData(!0)});const r=document.createElement("span");r.textContent=" Use regex",n.appendChild(this._regexCheckbox),n.appendChild(r),s.appendChild(n),this._statusRight=document.createElement("div"),this._statusRight.className="jp-ParquetViewer-statusRight",this._statusBar.appendChild(this._statusLeft),this._statusBar.appendChild(s),this._statusBar.appendChild(this._statusRight),this._tableContainer.appendChild(this._statusBar),this.node.appendChild(this._tableContainer),this._tableContainer.addEventListener("scroll",()=>{this._onScroll()}),this._cleanupHighlight=()=>{this._contextMenuOpen=!1,this._tbody.classList.remove("jp-ParquetViewer-context-menu-open"),this._tbody.querySelectorAll("tr").forEach(e=>{e.classList.remove("jp-ParquetViewer-row-context-active")}),this._menuObserver&&(this._menuObserver.disconnect(),this._menuObserver=null)},this._initialize()}_startMenuObserver(){this._menuObserver&&this._menuObserver.disconnect(),this._menuObserver=new MutationObserver(e=>{for(const t of e)if("childList"===t.type&&t.removedNodes.length>0)for(const e of Array.from(t.removedNodes))if(e instanceof HTMLElement&&(e.classList.contains("lm-Menu")||e.classList.contains("p-Menu")))return void(this._cleanupHighlight&&this._cleanupHighlight())}),this._menuObserver.observe(document.body,{childList:!0,subtree:!1})}getCleanupHighlight(){return this._cleanupHighlight||(()=>{})}async _initialize(){try{await this._loadMetadata(),await this._loadData(!0)}catch(e){this._showError(`Failed to load file: ${e}`)}}async _loadMetadata(){const e=await l("metadata",{method:"POST",body:JSON.stringify({path:this._filePath})});this._columns=e.columns,this._totalRows=e.totalRows,this._unfilteredTotalRows=e.totalRows,this._fileSize=e.fileSize||0,this._renderHeaders(),this._updateStatusBar()}async _loadData(e=!1){if(!this._loading){this._loading=!0,this._updateStatusBar("Loading...");try{e&&(this._currentOffset=0,this._data=[],this._tbody.innerHTML="");const t=await l("data",{method:"POST",body:JSON.stringify({path:this._filePath,offset:this._currentOffset,limit:this._limit,filters:this._filters,sortBy:this._sortBy,sortOrder:this._sortOrder,caseInsensitive:this._caseInsensitive,useRegex:this._useRegex})});this._data=this._data.concat(t.data),this._hasMore=t.hasMore,this._currentOffset+=t.data.length,e&&(this._totalRows=t.totalRows),this._renderData(t.data),this._updateStatusBar()}catch(e){this._showError(`Failed to load data: ${e}`)}finally{this._loading=!1}}}_renderHeaders(){this._filterRow.innerHTML="",this._headerRow.innerHTML="",this._columns.forEach(e=>{const t=document.createElement("th");t.className="jp-ParquetViewer-filterCell";const s=document.createElement("input");s.type="text",s.className="jp-ParquetViewer-filterInput",s.placeholder=this._getFilterPlaceholder(e.type),s.dataset.columnName=e.name,s.dataset.columnType=e.type,s.addEventListener("keyup",t=>{"Enter"===t.key&&this._applyFilter(e.name,s.value,e.type)}),t.appendChild(s),this._filterRow.appendChild(t);const i=document.createElement("th");i.className="jp-ParquetViewer-headerCell",i.style.cursor="pointer",i.dataset.columnName=e.name,i.addEventListener("click",()=>{this._toggleSort(e.name)});const a=document.createElement("div");a.className="jp-ParquetViewer-headerContent";const n=document.createElement("div");n.className="jp-ParquetViewer-columnName",n.textContent=e.name;const r=document.createElement("div");r.className="jp-ParquetViewer-columnType",r.textContent=this._simplifyType(e.type);const o=document.createElement("span");o.className="jp-ParquetViewer-sortIndicator",o.textContent="",a.appendChild(n),a.appendChild(r),i.appendChild(a),i.appendChild(o);const l=document.createElement("div");l.className="jp-ParquetViewer-resizeHandle",l.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation(),this._startResize(e.name,t.clientX,i)}),l.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation()}),i.appendChild(l),this._columnWidths.has(e.name)&&(i.style.width=`${this._columnWidths.get(e.name)}px`,t.style.width=`${this._columnWidths.get(e.name)}px`),this._headerRow.appendChild(i)})}_renderData(e){e.forEach(e=>{const t=document.createElement("tr");t.className="jp-ParquetViewer-row",this._columns.forEach(s=>{const i=document.createElement("td");i.className="jp-ParquetViewer-cell";const a=e[s.name];i.textContent=null!=a?String(a):"",this._columnWidths.has(s.name)&&(i.style.width=`${this._columnWidths.get(s.name)}px`),t.appendChild(i)}),t.addEventListener("mouseenter",()=>{this._contextMenuOpen||this._tbody.querySelectorAll("tr").forEach(e=>{e.classList.remove("jp-ParquetViewer-row-context-active")})}),t.addEventListener("contextmenu",s=>{this._contextMenuOpen=!0,this._tbody.classList.add("jp-ParquetViewer-context-menu-open"),this._tbody.querySelectorAll("tr").forEach(e=>{e.classList.remove("jp-ParquetViewer-row-context-active")}),t.classList.add("jp-ParquetViewer-row-context-active"),this._setLastContextMenuRow(e),this._startMenuObserver()}),this._tbody.appendChild(t)})}_startResize(e,t,s){this._resizing={columnName:e,startX:t,startWidth:s.offsetWidth},document.addEventListener("mousemove",this._doResize),document.addEventListener("mouseup",this._stopResize),document.body.style.userSelect="none",document.body.style.cursor="col-resize"}_applyFilter(e,t,s){if(t.trim())if(this._isNumericType(s)){const s=t.match(/^([><=]+)?\s*(.+)$/);if(s){const t=s[1]||"=",i=s[2].trim();this._filters[e]={type:"number",value:i,operator:t}}}else this._filters[e]={type:"text",value:t};else delete this._filters[e];this._loadData(!0)}_simplifyType(e){const t=e.toLowerCase();return t.includes("date32")||t.includes("date64")?"date":t.includes("timestamp")?"datetime":t.match(/^u?int(8|16|32|64)$/)?"int":t.match(/^(float|double)(16|32|64)?$/)?"float":t.includes("decimal")?"decimal":"bool"===t?"boolean":"string"===t||"utf8"===t||"large_string"===t||"large_utf8"===t?"string":"binary"===t||"large_binary"===t?"binary":t.startsWith("list")?"list":t.startsWith("struct")?"struct":e}_isNumericType(e){return["int","float","double","decimal","int8","int16","int32","int64","uint8","uint16","uint32","uint64"].some(t=>e.toLowerCase().includes(t))}_getFilterPlaceholder(e){return this._isNumericType(e)?"=, >, <, >=, <=":"text or regex..."}_onScroll(){const e=this._tableContainer;e.scrollTop+e.clientHeight>=e.scrollHeight-200&&this._hasMore&&!this._loading&&this._loadData(!1)}_toggleSort(e){this._sortBy===e?"asc"===this._sortOrder?this._sortOrder="desc":"desc"===this._sortOrder&&(this._sortBy=null,this._sortOrder="asc"):(this._sortBy=e,this._sortOrder="asc"),this._updateSortIndicators(),this._loadData(!0)}_updateSortIndicators(){this._headerRow.querySelectorAll("th").forEach(e=>{const t=e.dataset.columnName,s=e.querySelector(".jp-ParquetViewer-sortIndicator");t===this._sortBy?s.textContent="asc"===this._sortOrder?" ▲":" ▼":s.textContent=""})}_clearFilters(){this._filters={},this._filterRow.querySelectorAll("input").forEach(e=>{e.value=""}),this._loadData(!0)}_formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]}_updateStatusBar(e){if(e)this._statusLeft.textContent="",this._statusRight.textContent=e;else{const e=this._columns.length,t=this._formatFileSize(this._fileSize);this._statusLeft.textContent=`${e} columns • ${this._unfilteredTotalRows} rows • ${t}`;const s=Object.keys(this._filters).length;let i=`Showing ${this._data.length} of ${this._totalRows} rows`;if(s>0&&(i+=` (${s} filter${s>1?"s":""} active)`),this._statusRight.innerHTML=i,s>0){const e=document.createElement("a");e.href="#",e.className="jp-ParquetViewer-clearFilters",e.textContent="Clear filters",e.addEventListener("click",e=>{e.preventDefault(),this._clearFilters()}),this._statusRight.appendChild(document.createTextNode(" • ")),this._statusRight.appendChild(e)}}}_showError(e){this._tbody.innerHTML="";const t=document.createElement("tr"),s=document.createElement("td");s.colSpan=this._columns.length||1,s.className="jp-ParquetViewer-error",s.textContent=e,t.appendChild(s),this._tbody.appendChild(t)}dispose(){this._tableContainer.removeEventListener("scroll",this._onScroll),this._menuObserver&&(this._menuObserver.disconnect(),this._menuObserver=null),this._resizing&&(document.removeEventListener("mousemove",this._doResize),document.removeEventListener("mouseup",this._stopResize),document.body.style.userSelect="",document.body.style.cursor=""),super.dispose()}}class h extends i.DocumentWidget{constructor(e){super(e)}}class d extends i.ABCWidgetFactory{constructor(e,t,s){super(e),this._setLastContextMenuRow=t,this._setActiveWidget=s}createNewWidget(e){var t,s;console.log(`[Parquet Viewer] Creating widget for file: ${e.path}`),console.log(`[Parquet Viewer] File type: ${null===(t=e.contentsModel)||void 0===t?void 0:t.type}, Format: ${null===(s=e.contentsModel)||void 0===s?void 0:s.format}`);const i=new c(e.path,this._setLastContextMenuRow),a=new h({content:i,context:e});return a.title.label=e.path.split("/").pop()||"Parquet File",this._setActiveWidget(i),a}}const u={id:"jupyterlab_parquet_viewer_extension:plugin",description:"Jupyterlab extension to allow simple browsing of the parquet files with basic data filtering capabilities",autoStart:!0,requires:[a.ISettingRegistry],activate:async(e,t)=>{console.log("JupyterLab extension jupyterlab_parquet_viewer_extension is activated!");const{docRegistry:s,commands:i,contextMenu:a}=e;let n=null,r=null,o={enableParquet:!0,enableExcel:!1};console.log("[Parquet Viewer] Default settings:",o);try{console.log("[Parquet Viewer] Loading settings from registry with id:",u.id);const e=await t.load(u.id);o=e.composite,console.log("[Parquet Viewer] Loaded settings:",o),console.log("[Parquet Viewer] Settings detail - enableParquet:",o.enableParquet,"enableExcel:",o.enableExcel),e.changed.connect(()=>{o=e.composite,console.log("[Parquet Viewer] Settings changed:",o)})}catch(e){console.error("[Parquet Viewer] Failed to load settings:",e),console.log("[Parquet Viewer] Using default settings:",o)}const l="parquet-viewer:copy-row-json";i.addCommand(l,{label:"Copy Row as JSON",caption:"Copy the row data as JSON to clipboard",isEnabled:()=>null!==n,execute:async()=>{if(n){const e=JSON.stringify(n,null,2);await navigator.clipboard.writeText(e),console.log("Row copied to clipboard as JSON"),r&&r.getCleanupHighlight()()}}}),a.addItem({command:l,selector:".jp-ParquetViewer-row",rank:10}),console.log("[Parquet Viewer] Starting file type registration..."),console.log("[Parquet Viewer] Current settings state:",o);const c=[];if(o.enableParquet)try{s.addFileType({name:"parquet",displayName:"Parquet",extensions:[".parquet"],mimeTypes:["application/x-parquet"],iconClass:"jp-MaterialIcon jp-SpreadsheetIcon",contentType:"file",fileFormat:"base64"}),c.push("parquet"),console.log("[Parquet Viewer] Parquet file type registered")}catch(e){console.warn("[Parquet Viewer] Parquet file type already registered",e)}if(o.enableExcel)try{s.addFileType({name:"xlsx-parquet-viewer",displayName:"Excel (Parquet Viewer)",extensions:[".xlsx"],mimeTypes:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],iconClass:"jp-MaterialIcon jp-SpreadsheetIcon",contentType:"file",fileFormat:"base64"}),c.push("xlsx-parquet-viewer"),console.log("[Parquet Viewer] Excel file type registered")}catch(e){console.warn("[Parquet Viewer] Excel file type already registered",e)}if(c.length>0){const e=new d({name:"Parquet Viewer (Binary)",modelName:"base64",fileTypes:c,defaultFor:c,defaultRendered:c,readOnly:!0},e=>{n=e},e=>{r=e});s.addWidgetFactory(e),console.log(`[Parquet Viewer] Binary factory registered for: ${c.join(", ")}`)}else console.warn("[Parquet Viewer] No file types enabled in settings")}},p=u}}]);